# Listable Fields

## Overview

Listable fields control which fields are included in **list** operations.

The `@Listable` decorator allows you to specify which fields should be returned when
retrieving multiple records, enabling easy data retrieval and different levels of detail.

## Basic Usage

### Simple Listable Fields

Fields marked with `@Listable()` are included in LIST operations by default.

```typescript
import { Listable } from '@ajs/data-api/beta/metadata';
import { StaticModel } from './model';

@RegisterDataController()
class UserAPI extends DataController(User, DefaultRoutes.All, Controller('/users')) {
  @ModelReference()
  @StaticModel(UserModel, database_name)
  declare userModel: UserModel;

  @Access(AccessMode.ReadOnly)
  @Listable()
  declare _id: string;

  @Access(AccessMode.ReadOnly)
  @Listable()
  declare email: string;

  // This field won't appear in LIST responses
  declare password: string;
}
```

## Pluck Modes

The `@Listable` decorator supports different pluck modes to provide varying levels of detail, so some 
fields can be included in specific modes while others are excluded.

### Default Mode

```typescript
@Listable()  // Included in default list mode
declare name: string;

@Listable()  // Included in default list mode
declare email: string;
```

### Custom Pluck Modes

You can specify pluck modes by passing a boolean and a list name:

```typescript
@Listable()                    // Included in default list
@Listable(true, 'detailed')    // Included in list 'detailed'
declare description: string;

@Listable()                    // Only in default list
declare name: string;

@Listable(true, 'detailed')    // Only in list 'detailed'
declare internalNotes: string;
```

### Multiple Modes

A field can be included in multiple pluck modes:

```typescript
@Listable()
@Listable(true, 'detailed')
@Listable(true, 'summary')
declare name: string;
```

### Defining routes to access different pluck modes

To access different pluck modes, you must define routes in your data controller:

```typescript
class UserAPI extends DataController(
  User, { 
    detailed: DefaultRoutes.WithOptions(DefaultRoutes.List, { pluckMode: 'detailed' }),
    list: DefaultRoutes.List,
  }, 
  Controller('/users')) {
  // Model reference
  
  @Listable()                    // Only in default list
  declare name: string;

  @Listable(true, 'detailed')    // Only in list 'detailed'
  declare internalNotes: string;
}
```

## Pagination

List operations support pagination to handle large datasets. 
The response includes metadata about the pagination state.

### Pagination Parameters

- **`limit`**: Number of records to return per page (default varies by implementation)
- **`offset`**: Number of records to skip from the beginning
- **`maxPage`**: Maximum number of pages to return

### Response Format

List operations return a paginated response with the following structure:

- `results`: Array of records for the current page
- `total`: Total number of records available in the database table
- `offset`: Current page offset
- `limit`: Current limit of records per page


Complete the code snippet below to see the response format:
```typescript
{
  results: T[],    // Array of records
  total: number,   // Total number of records available in the database table
  offset: number,  // Current page offset
  limit: number    // Current limit
}
```

### Examples

#### Limit Results Per Page

You can limit the number of records returned per page using the `limit` parameter.

```typescript
// Get only 2 records per page
GET /users/list?limit=2

// Response
{
  "results": [
    { "_id": "0", "name": "Bob", "email": "bob@example.com" },
    { "_id": "1", "name": "Alice", "email": "alice@example.com" }
  ],
  "total": 100,
  "offset": 0,
  "limit": 2
}
```

#### Get specific page

To get a specific page, you can use the `offset` parameter to skip previous records.

```typescript
GET /users/list?offset=2

// Response
{
  "results": [
    { "_id": "2", "name": "Jean", "email": "Jean@example.com" },
    { "_id": "3", "name": "John", "email": "John@example.com" }
  ],
  "total": 100,
  "offset": 1,
  "limit": 2
}
```

#### Limit Maximum Pages

To prevent excessive data retrieval with large database requests, you can limit the maximum number of rows
returned per page using the `maxPage` parameter.

So even if requests specify a large `limit`, the API will only return the number of rows
specified by `maxPage` at most.

You can use `maxPage` by defining it in your data controller options:
```typescript
class UserAPI extends DataController(
  User,
  { list: DefaultRoutes.WithOptions(DefaultRoutes.List, { maxPage: 2 }) },
  Controller('/users')) {
  // Model reference

  @Listable()
  declare name: string;
}
```

```typescript
// Request with maxPage set to 10
GET /users/list?limit=100

// Response
{
  "results": [
    { "_id": "0", "name": "Bob" },
    { "_id": "1", "name": "Alice" }
    ],
    "total": 100,
    "offset": 0,
    "limit": 2
}
```

## Sorting

### Overview

Sorting in the Data API framework allows you to control which fields can be used for sorting in list operations.

The `@Sortable` decorator enables you to specify which fields can be sorted and how the sorting should be handled.

### Sortable Decorator

Fields marked with `@Sortable()` can be used for sorting in LIST operations.

```typescript
import { Sortable } from '@ajs/data-api/beta/metadata';
import { Listable } from './metadata';

@RegisterDataController()
class UserAPI extends DataController(User, DefaultRoutes.All, Controller('/users')) {
  // Model reference

  @Listable()
  @Access(AccessMode.ReadOnly)
  @Sortable()
  declare _id: string;

  @Listable()
  @Access(AccessMode.ReadOnly)
  @Sortable({ noIndex: true })
  declare name: string;

  @Listable()
  @Access(AccessMode.ReadOnly)
  @Sortable({ noIndex: true })
  declare age: number;

  @Listable()
  @Access(AccessMode.ReadOnly)
  @Sortable({ noIndex: true })
  declare registrationDate: Date;
}
```

### Sort Parameters

When using sortable fields, you can control sorting through query parameters:

- **`sortKey`**: The field name to sort by (must be marked with `@Sortable`)
- **`sortDirection`**: The sort direction ('asc' for ascending, 'desc' for descending)

### noIndex Option

The `noIndex` option indicates that the field doesn't have a database index for sorting:

```typescript
@Sortable({ noIndex: true })
declare name: string;
```

This is useful for fields that are frequently sorted but don't have database indexes,
allowing the framework to handle sorting efficiently.
### Example Sort Query

You can combine sorting with pagination parameters:

```http
GET /users/list?sortKey=age&sortDirection=asc&limit=3
```

**Response:**
```json
{
  "results": [
    { "_id": "2", "name": "Young User", "age": 18 },
    { "_id": "0", "name": "Adult User", "age": 30 },
    { "_id": "1", "name": "Senior User", "age": 65 }
  ],
  "total": 3,
  "offset": 0,
  "limit": 3
}
```