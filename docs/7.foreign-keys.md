# Foreign Keys

## Overview

The `@Foreign` decorator allows you to establish relationships between different database tables
in your Data API controllers. 
It enables you to reference and retrieve related data from other tables seamlessly,
creating a more structured and interconnected data model.

## Usage

### Simple Foreign Key Reference

The `@Foreign` decorator creates a relationship to another table by specifying the table name.

```typescript
import { Foreign } from '@ajs/data-api/beta/metadata';

@RegisterTable('users')
class User extends Table {
    @Index({ primary: true })
    declare _id: string;

    declare email: string;
    declare name: number;
}

@RegisterTable('card')
class Card extends Table {
    @Index({ primary: true })
    declare _id: string;

    declare user: string; // User ID as a foreign key
    declare items: string[]; // Array of CardItem IDs
    declare expirationDate: Date;
}

@RegisterTable('card_items')
class CardItem extends Table {
  @Index({ primary: true })
  declare _id: string;

  declare name: string;
  declare price: number;
}

@RegisterDataController()
class CardDataController extends DataController(Card, DefaultRoutes.All, Controller('/carts')) {
  @Listable()
  @Access(AccessMode.ReadOnly)
  declare _id: string;

  // References the 'users' table, using the variable name as the foreign key (default behavior)
  @Foreign('users')
  declare user: User;

  // References multiple items from 'card_items' table, using the 'items' field as the foreign key
  @Foreign('card_items', 'items', true)
  declare cartItems: CardItem[];
  
  declare expirationDate: Date;
}
```

### Foreign Key Parameters

The `@Foreign` decorator accepts three parameters:

```typescript
@Foreign(tableName: string, fieldName?: string, isArray?: boolean)
```

- **`tableName`** (required): The name of the referenced database table
- **`fieldName`** (optional): The field name in the current table that contains the foreign key. If not specified, use the variable name
- **`isArray`** (optional): Whether the relationship is an array of foreign keys. Defaults to `false` (single reference).

## Response Format

When using foreign keys, the API responses will include the related data:

### GET Response Example

```http
GET /carts/get?id=cart-123
```

**Response:**
```json
{
  "_id": "cart-123",
  "user": {
    "_id": "user-456",
    "name": "Bob Smith",
    "email": "bob@example.com"
  },
  "items": [
    {
      "_id": "item-789",
      "name": "Product A",
      "price": 29.99
    },
    {
      "_id": "item-790",
      "name": "Product B", 
      "price": 19.99
    }
  ]
}
```

## Error Handling

When foreign key relationships fail:

- **Missing References**: If a referenced record doesn't exist, the field will be `null` or `undefined`
- **Invalid IDs**: Invalid foreign key values will be ignored
- **Database Errors**: Database connection issues will result in standard error responses

## Continuing with Filters
See the [filters documentation](./8.filters.md) to learn how to add filtering capabilities to your data controllers.
