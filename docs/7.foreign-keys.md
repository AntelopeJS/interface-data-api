# Foreign Keys

## Overview

The `@Foreign` decorator allows you to establish relationships between different database tables
in your Data API controllers.
It enables you to reference and retrieve related data from other tables seamlessly,
creating a more structured and interconnected data model.

## Basic Usage

### Simple Foreign Key Reference

The `@Foreign` decorator creates a relationship to another table by specifying the table class or name.

```typescript
import { Foreign } from '@ajs/data-api/beta/metadata';

@RegisterTable('users')
class User extends Table {
    @Index({ primary: true })
    declare _id: string;

    declare email: string;
    declare name: string;
}

@RegisterTable('carts')
class Cart extends Table {
    @Index({ primary: true })
    declare _id: string;

    declare user: string; // User ID as a foreign key
    declare items: string[]; // Array of CartItem IDs
    declare expirationDate: Date;
}

@RegisterTable('cart_items')
class CartItem extends Table {
  @Index({ primary: true })
  declare _id: string;

  declare name: string;
  declare price: number;
}

@RegisterDataController()
class CartDataController extends DataController(Cart, DefaultRoutes.All, Controller('/carts')) {
  @Listable()
  @Access(AccessMode.ReadOnly)
  declare _id: string;

  // Using table class reference (recommended for type safety)
  @Foreign(User)
  declare user: User;

  // Using table name string with custom index and array flag
  @Foreign('cart_items', 'items', true)
  declare cartItems: CartItem[];

  declare expirationDate: Date;
}
```

## Foreign Key Parameters

The `@Foreign` decorator accepts up to four parameters:

```typescript
@Foreign(table: typeof Table | string, index?: string, multi?: boolean, pluck?: string[])
```

- **`table`** (required): Table class reference or table name string
  - Table class (recommended): `@Foreign(User)` - provides type safety
  - Table name string: `@Foreign('users')` - more flexible
- **`index`** (optional): Field name containing the foreign key id. Defaults to the property name
- **`multi`** (optional): Whether the relationship references multiple records. Defaults to `false`
- **`pluck`** (optional): Array of field names to retrieve from the foreign table. Retrieves all fields if not specified

## Advanced Usage

### Selective Field Retrieval with Pluck

The `pluck` parameter allows you to retrieve only specific fields from foreign tables,
reducing response size.

```typescript
@RegisterDataController()
class CartDataController extends DataController(Cart, DefaultRoutes.All, Controller('/carts')) {
  // Only retrieve name and email from the User table
  @Foreign(User, undefined, false, ['name', 'email'])
  declare user: User;

  // Only retrieve name and price from CartItem table
  @Foreign('cart_items', 'items', true, ['name', 'price'])
  declare cartItems: CartItem[];
}
```

### Table Class vs String Reference

You can specify the foreign table using either a class reference or a string:

```typescript
// Using class reference (recommended)
@Foreign(User)
declare user: User;

// Using string reference
@Foreign('users')
declare user: User;
```

**Class reference:**
- Can be analyzed by an IDE, providing autocompletion and errors highlighting
- Refactoring support (renaming "User" automatically updates references)
- Compile-time validation

**When to use string reference:**
- Dynamic table references
- Cross-module table references where importing the class creates circular dependencies

## Response Format

When using foreign keys, the API responses will include the related data:

### GET Response Example

```http
GET /carts/get?id=cart-123
```

**Response (without pluck):**
```json
{
  "_id": "cart-123",
  "user": {
    "_id": "user-456",
    "name": "Bob Smith",
    "email": "bob@example.com",
    "password": "hashed_value",
    "internalNotes": "..."
  },
  "items": [
    {
      "_id": "item-789",
      "name": "Product A",
      "price": 29.99,
      "cost": 15.00,
      "supplier": "..."
    }
  ]
}
```

**Response (with pluck - only selected fields):**
```json
{
  "_id": "cart-123",
  "user": {
    "_id": "user-456",
    "name": "Bob Smith",
    "email": "bob@example.com"
  },
  "items": [
    {
      "_id": "item-789",
      "name": "Product A",
      "price": 29.99
    }
  ]
}
```

## Error Handling

When foreign key relationships fail:

- **Missing References**: If a referenced record doesn't exist, the field will be `null` or `undefined`
- **Invalid IDs**: Invalid foreign key values will be ignored
- **Database Errors**: Database connection issues will result in standard error responses
- **Invalid Pluck Fields**: Requesting non-existent fields in pluck array is silently ignored

## Continuing with Filters
See the [filters documentation](./8.filters.md) to learn how to add filtering capabilities to your data controllers.
